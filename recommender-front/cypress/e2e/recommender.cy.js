import mockPOIS from '../mockData';

describe('Map and POI features', () => {
  beforeEach(() => {
    cy.intercept('GET', 'http://localhost:5000/api/poi/', mockPOIS);
    cy.intercept('GET', 'http://localhost:5000/api/warning', JSON.stringify(false));
    cy.visit('');
  });

  it('should display the MapContainer on initial load', () => {
    cy.get('.leaflet-container', { timeout: 10000 }).should('be.visible');
  });

  it('should display all POI markers on initial load', () => {
    cy.get('.leaflet-marker-icon', { timeout: 10000 })
      .should('have.length', mockPOIS.length);
  });

  it('should display clustered markers correctly', () => {
    // Create a copy of the mock POI data
    const clusteredMockPOIs = JSON.parse(JSON.stringify(mockPOIS));
    // Move one POI closer to another so they are clustered
    clusteredMockPOIs[0].latitude = 60.190;
    cy.intercept('GET', 'http://localhost:5000/api/poi/', clusteredMockPOIs);
    cy.visit('');

    cy.get('.leaflet-marker-icon', { timeout: 10000 })
      .should('have.length', mockPOIS.length - 1);
  });

  it('should update the popup content when the time slider is moved', () => {
    cy.get('.leaflet-marker-icon').first().click();

    cy.get('.leaflet-popup-content')
      .find('ul li')
      .should(($lis) => {
        expect($lis.eq(0)).to.contain('20.0 °C');
      });

    cy.get('span.MuiSlider-markLabel[data-index="1"]').click();

    cy.get('.leaflet-marker-icon').first().click();

    cy.get('.leaflet-popup-content')
      .find('ul li')
      .should(($lis) => {
        expect($lis.eq(0)).to.contain('-5.5 °C');
      });
  });

  it('should update amount of markers when accessibility is selected', () => {
    const wheelChairMockData = mockPOIS.slice(-1);
    cy.intercept('GET', 'http://localhost:5000/api/poi/wheelchair', wheelChairMockData);
    cy.get('.MuiSelect-select').click();
    cy.get('[data-value="wheelchair"]').click();
    cy.get('.leaflet-marker-icon', { timeout: 10000 })
      .should('have.length', wheelChairMockData.length);
  });

  it('should show the weather alert when /api/warning returns true', () => {
    cy.visit('');
    cy.intercept('GET', 'http://localhost:5000/api/warning', JSON.stringify(true));
    cy.contains('You should avoid going outside due to strong wind.').should('be.visible');
  });
});

describe('SimulatorPage', () => {
  beforeEach(() => {
    cy.visit('http://localhost:3000/admin');
  });

  it('should load the page', () => {
    cy.url().should('include', '/admin');
  });

  it('should render the map component', () => {
    cy.get('.simulator-map-container').should('be.visible');
  });

  it('should render the simulator form', () => {
    cy.get('.simulator-form-component').should('be.visible');
  });

  it('should show the weather alert when windSpeed is over threshold', () => {
    cy.get('input[name="windSpeed"]').clear().type('420');
    cy.contains('You should avoid going outside due to strong wind.').should('be.visible');
  });

  it('should allow input change in the SimulatorFormComponent', () => {
    cy.get('input[name="airTemperature"]').clear().type('20').should('have.value', '20');
  });
});

describe('TimePickerComponent', () => {
  beforeEach(() => {
    cy.visit('http://localhost:3000/admin');
  });

  it('should select an hour correctly', () => {
    cy.get('[data-testid="current-time-hour-selector"] div[role="button"]').first().click();
    cy.get('li[data-value="10"]').click();
    cy.get('[name="current-time-hour"]').should('have.value', '10');
  });

  it('should select a minute correctly', () => {
    cy.get('[data-testid="current-time-minute-selector"] div[role="button"]').first().click();
    cy.get('li[data-value="10"]').click();
    cy.get('[name="current-time-minute"]').should('have.value', '10');
  });

  it('should display correct default sunrise', () => {
    cy.get('[name="sunrise-hour"]').should('have.value', '06');
    cy.get('[name="sunrise-minute"]').should('have.value', '00');
  });

  it('should display correct default sunset', () => {
    cy.get('[name="sunset-hour"]').should('have.value', '22');
    cy.get('[name="sunset-minute"]').should('have.value', '00');
  });
});

describe('PreferenceSelector component', () => {
  beforeEach(() => {
    cy.intercept('GET', 'http://localhost:5000/api/poi/', mockPOIS);
    cy.intercept('GET', 'http://localhost:5000/api/warning', JSON.stringify(false));
    cy.visit('');
  });

  it('should have the "All" checkbox checked by default', () => {
    cy.get('input[name="allCheckbox"]').should('be.checked');
  });

  it('should deselect the "All" checkbox when another category is selected', () => {
    cy.get('[data-testid="menu-button"]').click();
    cy.get('input[name="Sport hallsCheckbox"]').check();
    cy.get('input[name="allCheckbox"]').should('be.not.be.checked');
  });

  it('should show only Sport halls markers when the "Sport halls" category is selected', () => {
    const sportHallsMockData = mockPOIS.filter((poi) => poi.category === 'Sport halls');
    cy.get('[data-testid="menu-button"]').click();
    cy.get('input[name="Sport hallsCheckbox"]').check();
    cy.get('.leaflet-marker-icon', { timeout: 10000 })
      .should('have.length', sportHallsMockData.length);
  });

  it('should select the "All" checkbox and deselect others when "All" is selected', () => {
    cy.get('[data-testid="menu-button"]').click();
    cy.get('input[name="Sport hallsCheckbox"]').check();
    cy.get('input[name="allCheckbox"]').check();
    cy.get('input[name="Sport hallsCheckbox"]').should('not.be.checked');
    cy.get('input[name="allCheckbox"]').should('be.checked');
  });

  it('should show all markers when the "All" category is re-selected', () => {
    cy.get('[data-testid="menu-button"]').click();
    cy.get('input[name="Sport hallsCheckbox"]').check();
    cy.get('input[name="allCheckbox"]').check();
    cy.get('.leaflet-marker-icon', { timeout: 10000 })
      .should('have.length', mockPOIS.length);
  });
});

describe('User location and routing feature', () => {

  const latitude = 60.169520;
  const longitude = 24.935450;
  
  // Mock route data
  const mockRoute = [[24.966048,60.217909],[24.965575,60.217646],[24.964889,60.217291],[24.965125,60.217177],[24.965125,60.217177],[24.965111,60.217168],[24.965085,60.217153],[24.965085,60.217153],[24.965023,60.217105],[24.965023,60.217105],[24.965214,60.217024],[24.965756,60.216835],[24.966193,60.216717],[24.966193,60.216717],[24.966713,60.216572],[24.966713,60.216572],[24.966915,60.216518],[24.966915,60.216518],[24.967246,60.216426],[24.967246,60.216426],[24.967193,60.216378],[24.967177,60.216363],[24.967177,60.216363],[24.967363,60.216299],[24.967363,60.216299],[24.967555,60.216236],[24.967688,60.216186],[24.967722,60.216168],[24.967742,60.216149],[24.967742,60.216149],[24.967747,60.216118],[24.967736,60.216075],[24.967736,60.216075],[24.967811,60.216],[24.967811,60.216],[24.967854,60.215953],[24.967875,60.215931],[24.967875,60.215931],[24.967896,60.215907],[24.967896,60.215907],[24.967928,60.215876],[24.967976,60.215827],[24.967976,60.215827],[24.968016,60.215781],[24.968029,60.215765],[24.968029,60.215765],[24.966936,60.215475],[24.966719,60.215408],[24.966442,60.215326],[24.966442,60.215326],[24.965924,60.215189],[24.9655,60.215079],[24.9655,60.215079],[24.965518,60.215033],[24.965712,60.214875],[24.965712,60.214875],[24.966922,60.213906],[24.966922,60.213906],[24.967332,60.213658],[24.967393,60.213631],[24.967393,60.213631],[24.967374,60.213621],[24.967317,60.213588],[24.967317,60.213588],[24.967962,60.213305],[24.968285,60.213158],[24.968581,60.213009],[24.96872,60.212919],[24.96872,60.212919],[24.968876,60.212815],[24.968876,60.212815],[24.968941,60.212768],[24.968941,60.212768],[24.968877,60.212747],[24.968877,60.212747],[24.969127,60.212562],[24.969379,60.212319],[24.96958,60.21212],[24.96958,60.21212],[24.968466,60.210758],[24.968466,60.210758],[24.968403,60.210628],[24.968375,60.210535],[24.968366,60.210445],[24.968364,60.210349],[24.968364,60.210349],[24.96835,60.209715],[24.968328,60.209581],[24.968286,60.209437],[24.968286,60.209437],[24.968256,60.209336],[24.968211,60.209193],[24.968211,60.209193],[24.968171,60.209074],[24.968171,60.209074],[24.968163,60.209054],[24.968163,60.209054],[24.968149,60.209016],[24.968149,60.209016],[24.968142,60.208996],[24.968142,60.208996],[24.968122,60.208943],[24.968122,60.208943],[24.968096,60.208857],[24.968096,60.208857],[24.968079,60.208797],[24.968079,60.208797],[24.96807,60.208768],[24.96807,60.208768],[24.9678,60.20794],[24.967782,60.207885],[24.967782,60.207885],[24.967722,60.207711],[24.967722,60.207711],[24.967667,60.207571],[24.967641,60.207527],[24.96752,60.207351],[24.967479,60.207284],[24.967372,60.207015],[24.967372,60.207015],[24.96734,60.206913],[24.96734,60.206913],[24.967333,60.206805],[24.967333,60.206805],[24.967324,60.206771],[24.967306,60.206719],[24.967306,60.206719],[24.967165,60.206422],[24.967165,60.206422],[24.967004,60.206123],[24.967004,60.206123],[24.966975,60.206072],[24.966975,60.206072],[24.966847,60.205861],[24.966847,60.205861],[24.966626,60.205498],[24.966545,60.205406],[24.966522,60.20538],[24.966522,60.20538],[24.966494,60.205328],[24.966494,60.205328],[24.966458,60.205258],[24.966458,60.205258],[24.96642,60.205187],[24.96642,60.205187],[24.966364,60.205088],[24.966364,60.205088],[24.966327,60.205024],[24.966327,60.205024],[24.966181,60.204795],[24.965959,60.204483],[24.965913,60.204426],[24.965858,60.204374],[24.965733,60.204278],[24.965684,60.204238],[24.965534,60.204064],[24.965534,60.204064],[24.965488,60.203994],[24.965421,60.2039],[24.965421,60.2039],[24.965386,60.203781],[24.965354,60.203735],[24.964929,60.203299],[24.964929,60.203299],[24.964809,60.2032],[24.964673,60.203104],[24.96458,60.203037],[24.964303,60.202824],[24.964303,60.202824],[24.964238,60.202768],[24.964147,60.202673],[24.964101,60.20263],[24.963615,60.202291],[24.963526,60.202241],[24.963526,60.202241],[24.963451,60.202212],[24.96338,60.202186],[24.963247,60.202156],[24.963119,60.202126],[24.963119,60.202126],[24.963163,60.202081],[24.963163,60.202081],[24.963186,60.202059],[24.963186,60.202059],[24.96321,60.202019],[24.96321,60.202019],[24.963235,60.201978],[24.963251,60.201934],[24.963234,60.201896],[24.963108,60.201792],[24.962991,60.201678],[24.962801,60.201487],[24.962801,60.201487],[24.962603,60.201269],[24.962416,60.201054],[24.962231,60.20081],[24.962073,60.200566],[24.961969,60.200387],[24.961871,60.200198],[24.96177,60.199981],[24.961696,60.19977],[24.961696,60.19977],[24.961651,60.199639],[24.961601,60.199539],[24.961553,60.199448],[24.961534,60.199416],[24.961533,60.199388],[24.961533,60.199388],[24.961526,60.199334],[24.961526,60.199334],[24.961513,60.199275],[24.961513,60.199275],[24.961467,60.199059],[24.961467,60.199059],[24.961459,60.19897],[24.961459,60.19897],[24.961449,60.198843],[24.961453,60.198613],[24.961453,60.198613],[24.961451,60.19853],[24.961439,60.198474],[24.961417,60.198413],[24.961417,60.198339],[24.961417,60.198339],[24.961435,60.198205],[24.961435,60.198205],[24.961445,60.19816],[24.961453,60.198141],[24.961494,60.198085],[24.961523,60.19789],[24.961572,60.197684],[24.961572,60.197684],[24.961602,60.197582],[24.961602,60.197582],[24.961606,60.197564],[24.961606,60.197564],[24.961617,60.197524],[24.961633,60.197479],[24.961633,60.197479],[24.961709,60.197262],[24.961709,60.197262],[24.961724,60.19722],[24.96172,60.19715],[24.96172,60.19715],[24.9617,60.197085],[24.9617,60.197085],[24.961789,60.197048],[24.961789,60.197048],[24.961735,60.196999],[24.961645,60.196949],[24.961645,60.196949],[24.961194,60.196701],[24.961194,60.196701],[24.96094,60.19656],[24.96094,60.19656],[24.960838,60.1965],[24.960838,60.1965],[24.960614,60.196374],[24.960614,60.196374],[24.960419,60.196266],[24.960419,60.196266],[24.959896,60.195979],[24.959896,60.195979],[24.959793,60.195923],[24.959793,60.195923],[24.959694,60.195869],[24.959694,60.195869],[24.959774,60.19583],[24.959774,60.19583],[24.959667,60.195774],[24.959667,60.195774],[24.959565,60.19572],[24.959526,60.1957],[24.959526,60.1957],[24.959134,60.195507],[24.959134,60.195507],[24.958991,60.195437],[24.958644,60.195269],[24.958644,60.195269],[24.958524,60.195211],[24.958524,60.195211],[24.958427,60.195165],[24.958427,60.195165],[24.958375,60.19514],[24.958375,60.19514],[24.957619,60.194764],[24.957619,60.194764],[24.957348,60.194629],[24.957348,60.194629],[24.95731,60.194608],[24.95731,60.194608],[24.957205,60.194546],[24.957205,60.194546],[24.957016,60.194439],[24.957016,60.194439],[24.956938,60.194396],[24.956938,60.194396],[24.956775,60.194311],[24.956775,60.194311],[24.95682,60.194287],[24.95682,60.194287],[24.956629,60.194172],[24.956629,60.194172],[24.956323,60.194021],[24.956323,60.194021],[24.956267,60.193982],[24.956267,60.193982],[24.956219,60.193949],[24.956219,60.193949],[24.955726,60.193705],[24.955685,60.193692],[24.955685,60.193692],[24.955633,60.193675],[24.955633,60.193675],[24.955567,60.193645],[24.955567,60.193645],[24.955503,60.19362],[24.955391,60.193566],[24.955391,60.193566],[24.955057,60.193394],[24.955057,60.193394],[24.955026,60.193378],[24.954982,60.193355],[24.954982,60.193355],[24.954919,60.193331],[24.954919,60.193331],[24.954551,60.193154],[24.954487,60.19313],[24.954417,60.193114],[24.954417,60.193114],[24.954264,60.193073],[24.954264,60.193073],[24.954167,60.19305],[24.954167,60.19305],[24.954067,60.193028],[24.954067,60.193028],[24.953792,60.192943],[24.953792,60.192943],[24.95353,60.192854],[24.953331,60.192784],[24.953331,60.192784],[24.952971,60.192656],[24.952868,60.192607],[24.952341,60.192317],[24.952341,60.192317],[24.952314,60.192302],[24.952314,60.192302],[24.952252,60.192268],[24.952252,60.192268],[24.952185,60.192228],[24.952185,60.192228],[24.952161,60.192213],[24.952161,60.192213],[24.951781,60.19199],[24.951781,60.19199],[24.950522,60.191244],[24.950489,60.191222],[24.950489,60.191222],[24.950426,60.191179],[24.950426,60.191179],[24.950372,60.191143],[24.950372,60.191143],[24.950351,60.191129],[24.950351,60.191129],[24.950167,60.191025],[24.950167,60.191025],[24.949593,60.190686],[24.949593,60.190686],[24.94954,60.190637],[24.94954,60.190637],[24.949522,60.190617],[24.949479,60.190577],[24.949479,60.190577],[24.94944,60.19054],[24.949405,60.190509],[24.949405,60.190509],[24.949621,60.190437],[24.949621,60.190437],[24.949796,60.190377],[24.950136,60.190237],[24.950136,60.190237],[24.950162,60.190226],[24.950162,60.190226],[24.950212,60.190206],[24.950212,60.190206],[24.950412,60.190129],[24.950412,60.190129],[24.950475,60.190104],[24.950475,60.190104],[24.950798,60.18999],[24.951012,60.189921]];

  beforeEach(() => {
    cy.intercept('GET', 'http://localhost:5000/api/poi/', mockPOIS);
    cy.intercept('GET', 'http://localhost:5000/api/warning', JSON.stringify(false));
    
    // Mock the geolocation
    cy.window().then((win) => {
      cy.stub(win.navigator.geolocation, 'getCurrentPosition', (callback) => {
        return callback({ coords: { latitude, longitude } });
      });
    });

    cy.visit('http://localhost:3000');
  });

  it('should locate the user, open a POI and set a destination, draw the polyline', () => {

    cy.get('[data-testid="locate-button"]').should('be.visible').click();


    cy.get('.leaflet-marker-icon').eq(1).click();

    cy.get('.leaflet-popup-content');

    cy.intercept('GET', '**/path?start=*&end=*', { body: mockRoute }).as('getRoute');

    cy.get('[data-cy="set-destination-button"]').click();


    cy.get('#map').find('path.leaflet-interactive').should('exist');
  });

  // Additional checks for the polyline coordinates can be added if required
});
